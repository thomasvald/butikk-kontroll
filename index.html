<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
<title>Butikk-kontroll – Mobil</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
  :root {
    --bg: #0b0b0c;
    --card: #111114;
    --muted: #9aa0a6;
    --text: #e8eaed;
    --border: #26272b;
    --accent: #16a34a;
    --danger: #e11d48;
    --gold: #fbbf24;
  }
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  html, body { height: 100%; }
  body { margin: 0; font-family: -apple-system, system-ui, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial; color: var(--text); background: #0b0b0c; }
  .app { max-width: 560px; margin: 0 auto; padding: env(safe-area-inset-top) 16px calc(env(safe-area-inset-bottom) + 16px); }
  header { position: sticky; top: 0; z-index: 10; background: linear-gradient(180deg, rgba(11,11,12,0.95), rgba(11,11,12,0.75)); backdrop-filter: blur(6px); padding: 10px 0 12px; }
  h1 { margin: 0; font-size: 20px; font-weight: 800; }
  .sub { margin: 4px 0 0; color: var(--muted); font-size: 12px; }
  .card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 14px; box-shadow: 0 8px 30px rgba(0,0,0,0.25); margin: 12px 0; }
  .row { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
  .col { display: flex; flex-direction: column; gap: 8px; }
  label { font-size: 12px; color: var(--muted); }
  input[type="number"], input[type="text"], select, textarea, input[type="date"] {
    width: 100%; background: #0f1115; color: var(--text); border: 1px solid var(--border); border-radius: 14px; padding: 12px 14px; font-size: 16px;
  }
  textarea { min-height: 64px; resize: vertical; }
  .btn { width: 100%; border: 0; padding: 14px 16px; border-radius: 14px; color: white; background: #2a2b31; font-weight: 800; font-size: 16px; }
  .btn.primary { background: var(--accent); }
  .btn.danger { background: var(--danger); }
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  .stat { display: flex; flex-direction: column; gap: 2px; }
  .stat .label { color: var(--muted); font-size: 12px; }
  .stat .value { font-size: 22px; font-weight: 900; }
  .center { text-align: center; }
  .muted { color: var(--muted); }
  .badge { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:#0f1115; font-size:12px; color:var(--muted); }
  .delta-pos { color: #22c55e; font-weight: 800; }
  .delta-neg { color: #ef4444; font-weight: 800; }
  .winner { border-color: var(--gold); box-shadow: 0 0 0 2px rgba(251,191,36,0.2) inset; }
  .trophy { color: var(--gold); }
  .table { width: 100%; border-collapse: collapse; }
  .table th, .table td { padding: 10px 8px; border-bottom: 1px solid var(--border); font-size: 14px; }
  .right { text-align: right; }
  .small { font-size: 12px; }
</style>
</head>
<body>
  <header class="app">
    <h1>Butikk-kontroll – Mobil</h1>
    <div class="sub">iPhone-klar • Lagres lokalt • Ukevis score</div>
  </header>

  <main class="app">
    <!-- Skjema -->
    <div class="card">
      <div class="row" style="justify-content: space-between;">
        <div class="badge"><span id="badgeWeek"></span></div>
        <div class="badge">Avdeling: <strong id="badgeDept">Home</strong></div>
      </div>
      <div class="col" style="margin-top:8px;">
        <div class="grid-2">
          <div>
            <label>Avdeling</label>
            <select id="avdSel">
              <option>Home</option>
              <option>Tech</option>
            </select>
          </div>
          <div>
            <label>Dato</label>
            <input type="date" id="inpDate">
          </div>
        </div>
        <div class="grid-2">
          <div>
            <label>Tomme pigger</label>
            <input type="number" id="inpPigger" inputmode="numeric" min="0" value="0">
          </div>
          <div>
            <label>Manglende priser</label>
            <input type="number" id="inpPriser" inputmode="numeric" min="0" value="0">
          </div>
          <div>
            <label>Tomme hylleplasser</label>
            <input type="number" id="inpHyller" inputmode="numeric" min="0" value="0">
          </div>
          <div>
            <label>Rot</label>
            <input type="number" id="inpRot" inputmode="numeric" min="0" value="0">
          </div>
        </div>
        <div>
          <label>Ansvarlig (valgfritt)</label>
          <input type="text" id="inpAnsvarlig" placeholder="F.eks. Thomas">
        </div>
        <div>
          <label>Notat (valgfritt)</label>
          <textarea id="inpNotat" placeholder="Kort beskrivelse/område"></textarea>
        </div>
        <button class="btn primary" id="btnSubmit">Legg til registrering (overskriv uke)</button>
        <div class="small muted">Når du trykker, oppdateres scorene for valgt uke og avdeling (overskriver eventuell tidligere registrering samme uke).</div>
      </div>
    </div>

    <!-- Uke-summer + delta -->
    <div class="card">
      <div class="row" style="justify-content: space-between;">
        <div class="badge">Denne uken: <strong id="wkNow"></strong></div>
        <div class="badge">Forrige uke: <strong id="wkPrev"></strong></div>
      </div>

      <div id="deptStats" class="col" style="margin-top:10px;"></div>
    </div>

    <!-- Konkurranse -->
    <div class="card" id="compCard">
      <div class="row" style="justify-content: space-between; margin-bottom:8px;">
        <strong>Konkurranse – Lavest total vinner</strong>
        <span class="small muted">Gjelder denne uken</span>
      </div>
      <div id="compWrap" class="col"></div>
    </div>

    <!-- Historikk (liste) -->
    <div class="card">
      <div class="row" style="justify-content: space-between; margin-bottom:8px;">
        <strong>Historikk (ukevis)</strong>
        <button class="btn" id="btnExportCsv">Eksporter CSV</button>
      </div>
      <table class="table">
        <thead>
          <tr>
            <th>Uke</th>
            <th>Avdeling</th>
            <th class="right">Tomme pigger</th>
            <th class="right">Manglende priser</th>
            <th class="right">Tomme hyller</th>
            <th class="right">Rot</th>
            <th class="right">Total</th>
          </tr>
        </thead>
        <tbody id="histRows">
          <tr><td colspan="7" class="center muted small" style="padding:12px;">Ingen data enda.</td></tr>
        </tbody>
      </table>
    </div>

    <div class="small muted" style="padding: 4px 2px 16px;">Tips: Legg siden til Hjem-skjermen i Safari: Del → Legg til på Hjem-skjermen.</div>
  </main>

<script>
(function() {
  const STORAGE_KEY = "butikk_kontroll_weekly_v1";
  const AVDELINGER = ["Home", "Tech"];
  let state = { // structure: { "2025-W33": { Home: {pigger,priser,hyller,rot,ansvarlig,notat}, Tech: {...} } }
    weeks: {}
  };

  const $ = (id) => document.getElementById(id);
  const inpDate = $("inpDate");
  const avdSel = $("avdSel");
  const badgeWeek = $("badgeWeek");
  const badgeDept = $("badgeDept");
  const deptStats = $("deptStats");
  const compWrap = $("compWrap");
  const histRows = $("histRows");
  const wkNow = $("wkNow");
  const wkPrev = $("wkPrev");

  function load(){
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if(raw) state = JSON.parse(raw) || state;
    } catch(e){}
  }
  function save(){
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch(e){}
  }

  function todayStr(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd}`;
  }

  // ISO week helpers
  function toISOWeek(d){
    // Copy date
    const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    // Set to nearest Thursday: current date + 4 - current day number
    // Make Sunday's day number 7
    const dayNum = (date.getUTCDay() + 6) % 7;
    date.setUTCDate(date.getUTCDate() - dayNum + 3);
    // ISO week year
    const isoYear = date.getUTCFullYear();
    // Jan 4 is always in week 1.
    const jan4 = new Date(Date.UTC(isoYear, 0, 4));
    // Number of days between date and Jan 4.
    const diff = (date - jan4) / 86400000;
    // Calculate week number
    const week = 1 + Math.round((diff) / 7);
    return { isoYear, week };
  }
  function fmtWeekKey(dateStr){
    const d = new Date(dateStr + "T00:00:00");
    const { isoYear, week } = toISOWeek(d);
    return `${isoYear}-W${String(week).padStart(2,'0')}`;
  }

  function numberOrZero(n){
    const x = Number(n);
    return Number.isFinite(x) && x >= 0 ? Math.floor(x) : 0;
  }

  function totalScore(obj){ return (obj.pigger||0) + (obj.priser||0) + (obj.hyller||0) + (obj.rot||0); }

  function setToday(){
    inpDate.value = todayStr();
    updateBadges();
  }

  function updateBadges(){
    const weekKey = fmtWeekKey(inpDate.value);
    badgeWeek.textContent = `Uke ${weekKey}`;
    badgeDept.textContent = avdSel.value;
    wkNow.textContent = weekKey;
    // previous week
    const d = new Date(inpDate.value + "T00:00:00");
    d.setDate(d.getDate() - 7);
    wkPrev.textContent = fmtWeekKey(d.toISOString().slice(0,10));
  }

  function onSubmit(){
    const weekKey = fmtWeekKey(inpDate.value);
    const dept = avdSel.value;
    const entry = {
      pigger: numberOrZero($("inpPigger").value),
      priser: numberOrZero($("inpPriser").value),
      hyller: numberOrZero($("inpHyller").value),
      rot: numberOrZero($("inpRot").value),
      ansvarlig: $("inpAnsvarlig").value.trim(),
      notat: $("inpNotat").value.trim()
    };
    if(!state.weeks[weekKey]) state.weeks[weekKey] = {};
    // OVERWRITE behavior for week+dept
    state.weeks[weekKey][dept] = entry;
    save();
    renderAll();
    // scroll to stats
    document.querySelector("#deptStats")?.scrollIntoView({ behavior: "smooth", block: "start" });
  }

  function renderDeptStat(weekKey, dept){
    const cur = state.weeks[weekKey]?.[dept] || { pigger:0, priser:0, hyller:0, rot:0 };
    // previous week key
    const d = new Date(inpDate.value + "T00:00:00");
    d.setDate(d.getDate() - 7);
    const prevKey = fmtWeekKey(d.toISOString().slice(0,10));
    const prev = state.weeks[prevKey]?.[dept] || { pigger:0, priser:0, hyller:0, rot:0 };
    const curTotal = totalScore(cur);
    const prevTotal = totalScore(prev);
    const delta = curTotal - prevTotal; // positive = worse (higher), negative = improvement
    const deltaCls = delta <= 0 ? "delta-pos" : "delta-neg";
    const arrow = delta <= 0 ? "▲ Forbedring" : "▼ Forverring";
    const title = dept === "Home" ? "Home" : "Tech";

    const el = document.createElement("div");
    el.className = "card " + (curTotal <= (state.weeks[weekKey]?.[dept==="Home"?"Tech":"Home"] ? totalScore(state.weeks[weekKey][dept==="Home"?"Tech":"Home"]) : Infinity) ? "winner" : "");
    el.innerHTML = `
      <div class="row" style="justify-content: space-between;">
        <strong>${title}</strong>
        <span class="badge">Total: <strong>${curTotal}</strong></span>
      </div>
      <div class="grid-2" style="margin-top:8px;">
        <div class="stat"><span class="label">Tomme pigger</span><span class="value">${cur.pigger||0}</span></div>
        <div class="stat"><span class="label">Manglende priser</span><span class="value">${cur.priser||0}</span></div>
        <div class="stat"><span class="label">Tomme hyller</span><span class="value">${cur.hyller||0}</span></div>
        <div class="stat"><span class="label">Rot</span><span class="value">${cur.rot||0}</span></div>
      </div>
      <div class="row" style="margin-top:8px; justify-content: space-between;">
        <div class="small muted">Forrige uke: <strong>${prevTotal}</strong></div>
        <div class="${deltaCls} small"><strong>${arrow}</strong> (${delta <= 0 ? "" : "+"}${delta})</div>
      </div>
    `;
    return el;
  }

  function renderCompetition(weekKey){
    const curHome = state.weeks[weekKey]?.Home ? totalScore(state.weeks[weekKey].Home) : null;
    const curTech = state.weeks[weekKey]?.Tech ? totalScore(state.weeks[weekKey].Tech) : null;

    compWrap.innerHTML = "";
    const row = document.createElement("div");
    row.className = "row";
    row.style.justifyContent = "space-between";

    const card = (label, score) => {
      const div = document.createElement("div");
      div.className = "card";
      div.style.flex = "1";
      div.innerHTML = `
        <div class="center small muted" style="margin-bottom:6px;">${label}</div>
        <div class="center" style="font-size:28px; font-weight:900;">${score===null?"—":score}</div>
      `;
      return div;
    };
    const a = card("Home", curHome);
    const b = card("Tech", curTech);

    // Mark winner
    if(curHome !== null && curTech !== null){
      if(curHome < curTech){ a.classList.add("winner"); }
      else if(curTech < curHome){ b.classList.add("winner"); }
      else { /* tie - none */ }
    }
    row.appendChild(a); row.appendChild(b);
    compWrap.appendChild(row);

    // Winner line
    const line = document.createElement("div");
    line.className = "center small";
    line.style.marginTop = "8px";
    if(curHome === null && curTech === null) {
      line.textContent = "Ingen registreringer for denne uken ennå.";
    } else if(curHome === null || curTech === null) {
      line.textContent = "Ventende på begge avdelinger for å kåre vinner 🔔";
    } else if(curHome < curTech) {
      line.innerHTML = '<span class="trophy">🏆</span> Home leder!';
    } else if(curTech < curHome) {
      line.innerHTML = '<span class="trophy">🏆</span> Tech leder!';
    } else {
      line.textContent = "Uavgjort denne uken.";
    }
    compWrap.appendChild(line);
  }

  function renderHistory(){
    const rows = [];
    for(const wk of Object.keys(state.weeks).sort()){
      for(const dept of AVDELINGER){
        const v = state.weeks[wk][dept];
        if(!v) continue;
        rows.push({ week: wk, dept, ...v, total: totalScore(v) });
      }
    }
    histRows.innerHTML = "";
    if(rows.length === 0){
      const tr = document.createElement("tr");
      tr.innerHTML = '<td colspan="7" class="center muted small" style="padding:12px;">Ingen data enda.</td>';
      histRows.appendChild(tr);
      return;
    }
    for(const r of rows){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.week}</td>
        <td>${r.dept}</td>
        <td class="right">${r.pigger}</td>
        <td class="right">${r.priser}</td>
        <td class="right">${r.hyller}</td>
        <td class="right">${r.rot}</td>
        <td class="right"><strong>${r.total}</strong></td>
      `;
      histRows.appendChild(tr);
    }
  }

  function exportCSV(){
    const header = ['uke','avdeling','tomme_pigger','manglende_priser','tomme_hylleplasser','rot','total'];
    const rows = [];
    for(const wk of Object.keys(state.weeks).sort()){
      for(const dept of AVDELINGER){
        const v = state.weeks[wk][dept];
        if(!v) continue;
        rows.push([wk, dept, v.pigger||0, v.priser||0, v.hyller||0, v.rot||0, totalScore(v)]);
      }
    }
    const esc = (s)=>{
      s = String(s);
      if(s.includes('"')) s = s.replaceAll('"','""');
      if(/[",\n]/.test(s)) s = `"${s}"`;
      return s;
    };
    const csv = [header, ...rows].map(cols=>cols.map(esc).join(',')).join('\\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'butikk-kontroll_ukevis.csv'; a.click(); URL.revokeObjectURL(url);
  }

  function renderAll(){
    const weekKey = fmtWeekKey(inpDate.value);
    updateBadges();
    // dept cards (Home + Tech)
    deptStats.innerHTML = "";
    deptStats.appendChild(renderDeptStat(weekKey, "Home"));
    deptStats.appendChild(renderDeptStat(weekKey, "Tech"));
    // competition
    renderCompetition(weekKey);
    // history
    renderHistory();
  }

  // Init
  load();
  setToday();
  renderAll();

  // Events
  $("btnSubmit").addEventListener("click", (e)=>{ e.preventDefault(); onSubmit(); });
  $("btnExportCsv").addEventListener("click", exportCSV);
  avdSel.addEventListener("change", updateBadges);
  inpDate.addEventListener("change", ()=>{ updateBadges(); renderAll(); });
  // update top badges live
  setInterval(updateBadges, 30000);
})();
</script>
</body>
</html>
